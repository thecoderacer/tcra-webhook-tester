name: CI - Validation & Security

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1

jobs:
  validation:
    name: Configuration Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          echo "üîç Validating docker-compose.yml..."
          docker compose config > /dev/null
          echo "‚úÖ Docker Compose configuration is valid"

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            docker-compose.yml
            .github/workflows/*.yml
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              comments:
                min-spaces-from-content: 1

      - name: Validate Nginx Configuration
        run: |
          echo "üîç Validating nginx configurations..."

          # Check nginx.conf syntax
          docker run --rm -v $(pwd)/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
            nginx:alpine nginx -t -c /etc/nginx/nginx.conf || {
              echo "‚ùå nginx.conf validation failed"
              exit 1
            }

          echo "‚úÖ Nginx configuration is valid"

      - name: Validate Environment Template
        run: |
          echo "üîç Validating .env.example..."

          # Check if required variables exist
          required_vars=(
            "WEBHOOK_TESTER_HOST"
          )

          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env.example; then
              echo "‚ùå Missing required variable: $var"
              exit 1
            fi
          done

          echo "‚úÖ Environment template is valid"

  security-scanning:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret Scanning with TruffleHog
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before || 'HEAD~1' }}
          head: HEAD

      - name: Docker Image Vulnerability Scanning (webhook-tester)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: 'tarampampam/webhook-tester:latest'
          format: 'sarif'
          output: 'trivy-webhook-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-*.sarif'
          category: 'docker-images'

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validation, security-scanning]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "üìä CI Pipeline Summary"
          echo "======================"
          echo ""
          echo "Validation: ${{ needs.validation.result }}"
          echo "Security Scanning: ${{ needs.security-scanning.result }}"
          echo ""

          if [ "${{ needs.validation.result }}" != "success" ]; then
            echo "‚ùå CI Pipeline FAILED: Validation failed"
            exit 1
          elif [ "${{ needs.security-scanning.result }}" == "failure" ]; then
            echo "‚ö†Ô∏è  CI Pipeline PASSED with security warnings"
            echo ""
            echo "Security scans detected some issues (check Security tab for details)"
            echo "These are non-blocking warnings. Review and address them when possible."
            echo ""
            echo "Ready for deployment! üöÄ"
          else
            echo "‚úÖ CI Pipeline PASSED"
            echo ""
            echo "Ready for deployment! üöÄ"
          fi
